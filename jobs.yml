jobs:
  - name: build-lifecycle-binaries
    plan:
      - get: lifecycle-repo
        trigger: true
        version: every
      - get: ci
      - get: lifecycle-image-version
        params:
          pre: alpha
      - get: lifecycle-build-version
        params:
          pre: build
      - aggregate:
        - task: format-lifecycle
          file: ci/tasks/format-lifecycle/task.yml
        - task: run-unit-tests
          privileged: true
          file: ci/tasks/run-lifecycle-unit/task.yml
        - task: build-binaries
          privileged: true
          file: ci/tasks/build-lifecycle-binaries/task.yml
      - aggregate:
        - put: detector-gcs
          resource: lifecycle-gcs
          params:
            file: lifecycle-binaries/detector-*
        - put: analyzer-gcs
          resource: lifecycle-gcs
          params:
            file: lifecycle-binaries/analyzer-*
        - put: builder-gcs
          resource: lifecycle-gcs
          params:
            file: lifecycle-binaries/builder-*
        - put: exporter-gcs
          resource: lifecycle-gcs
          params:
            file: lifecycle-binaries/exporter-*
        - put: launcher-gcs
          resource: lifecycle-gcs
          params:
            file: lifecycle-binaries/launcher-*
      - put:  lifecycle-build-version
        params:
          file: lifecycle-build-version/version

  - name: build-stack-images
    plan:
      - get: lifecycle-repo
        trigger: true
        passed: [build-lifecycle-binaries]
      - get: ci
        passed: [build-lifecycle-binaries]
      - get: lifecycle-image-version
        passed: [build-lifecycle-binaries]
        params:
          pre: alpha
      - get: lifecycle-build-version
        passed: [build-lifecycle-binaries]
      - task: build-images
        privileged: true
        file: ci/tasks/build-stack-images/task.yml
      - aggregate:
        - put: packs-base-image
          params:
            load_file: built-lifecycle-images/base.tar
            load_repository: packs/base # port needed for private repos
            load_tag: dev
            tag_file: built-lifecycle-version/version
        - put: packs-run-image
          params:
            load_file: built-lifecycle-images/run.tar
            load_repository: packs/run # port needed for private repos
            load_tag: dev
            tag_file: built-lifecycle-version/version
        - put: packs-build-image
          params:
            load_file: built-lifecycle-images/build.tar
            load_repository: packs/build # port needed for private repos
            load_tag: dev
            tag_file: built-lifecycle-version/version
        - put: packs-samples-image
          params:
            load_file: built-lifecycle-images/samples.tar
            load_repository: packs/samples # port needed for private repos
            load_tag: dev
            tag_file: built-lifecycle-version/version

  - name: pack-unit
    plan:
      - aggregate:
        - get: pack-repo
          resource: pack-repo
          trigger: true
          version: every
        - get: ci
      - task: run-unit-tests
        privileged: true
        file: ci/tasks/run-pack-unit/task.yml

  - name: acceptance
    plan:
      - aggregate:
        - get: pack-repo
          resource: pack-repo
        - get: ci
          passed: [build-stack-images]
        - get: packs-build-image
          passed: [build-stack-images]
          params: {save: true}
        - get: packs-run-image
          passed: [build-stack-images]
          params: {save: true}
        - get: packs-samples-image
          passed: [build-stack-images]
          trigger: true
          params: {save: true}
        - get: lifecycle-image-version
          passed: [build-stack-images]
        - get: lifecycle-build-version
          passed: [build-stack-images]
      - task: acceptance
        privileged: true
        file: ci/tasks/run-acceptance/task.yml

  - name: release-lifecycle
    plan:
      - aggregate:
        - get: ci
          passed: [acceptance]
        - get: lifecycle-image-version
          passed: [acceptance]
        - get: lifecycle-build-version
          passed: [acceptance]
      - task: release-version-create
          file: ci/tasks/build-stack-images/task.yml
      - aggregate:
        - put: packs-base-image
          params:
            additional_tags: accepted-lifecycle-version/version
            additional_tag_names: release-lifecycle-version/version
#        - put: packs-run-image
#          params:
#            load_file: built-lifecycle-images/run.tar
#            load_repository: packs/run # port needed for private repos
#            load_tag: dev
#            tag_file: built-lifecycle-version/version
#        - put: packs-build-image
#          params:
#            load_file: built-lifecycle-images/build.tar
#            load_repository: packs/build # port needed for private repos
#            load_tag: dev
#            tag_file: built-lifecycle-version/version
#        - put: packs-samples-image
#          params:
#            load_file: built-lifecycle-images/samples.tar
#            load_repository: packs/samples # port needed for private repos
#            load_tag: dev
#            tag_file: built-lifecycle-version/version